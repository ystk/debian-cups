From: Thorsten Alteholz <debian@alteholz.de>
Date: Sun, 25 Jun 2023 01:06:15 +0200
Subject: CVE-2023-34241

---
 scheduler/client.c | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/scheduler/client.c b/scheduler/client.c
index f1181b7..cd20da0 100644
--- a/scheduler/client.c
+++ b/scheduler/client.c
@@ -270,16 +270,16 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
     * Can't have an unresolved IP address with double-lookups enabled...
     */
 
+    cupsdLogMessage(CUPSD_LOG_WARN,
+                    "Name lookup failed - closing connection from %s!",
+                    con->http.hostname);
+
 #ifdef WIN32
     closesocket(con->http.fd);
 #else
     close(con->http.fd);
 #endif /* WIN32 */
 
-    cupsdLogMessage(CUPSD_LOG_WARN,
-                    "Name lookup failed - connection from %s closed!",
-                    con->http.hostname);
-
     free(con);
     return;
   }
@@ -313,15 +313,16 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
       * with double-lookups enabled...
       */
 
+      cupsdLogMessage(CUPSD_LOG_WARN,
+                      "IP lookup failed - closing connection from %s!",
+                      con->http.hostname);
+
 #ifdef WIN32
       closesocket(con->http.fd);
 #else
       close(con->http.fd);
 #endif /* WIN32 */
 
-      cupsdLogMessage(CUPSD_LOG_WARN,
-                      "IP lookup failed - connection from %s closed!",
-                      con->http.hostname);
       free(con);
       return;
     }
@@ -337,15 +338,17 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
 
   if (!hosts_access(&wrap_req))
   {
+
+    cupsdLogMessage(CUPSD_LOG_WARN,
+                    "Connection from %s refused by /etc/hosts.allow and "
+		    "/etc/hosts.deny rules.", con->http.hostname);
+
 #ifdef WIN32
     closesocket(con->http.fd);
 #else
     close(con->http.fd);
 #endif /* WIN32 */
 
-    cupsdLogMessage(CUPSD_LOG_WARN,
-                    "Connection from %s refused by /etc/hosts.allow and "
-		    "/etc/hosts.deny rules.", con->http.hostname);
     free(con);
     return;
   }
