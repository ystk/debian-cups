From a9a7daa77699bd58001c25df8a61a8029a217ddf Mon Sep 17 00:00:00 2001
From: Zdenek Dohnal <zdohnal@redhat.com>
Date: Fri, 1 Sep 2023 16:47:29 +0200
Subject: [PATCH] raster-interpret.c: Fix CVE-2023-4504

We didn't check for end of buffer if it looks there is an escaped
character - check for NULL terminator there and if found, return NULL
as return value and in `ptr`, because a lone backslash is not
a valid PostScript character.
---
 cups/raster-interpret.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

Index: cups/filter/interpret.c
===================================================================
--- cups.orig/filter/interpret.c	2023-09-30 19:50:44.893318592 +0200
+++ cups/filter/interpret.c	2023-09-30 19:50:44.889318592 +0200
@@ -1079,6 +1079,18 @@
 
 	    cur ++;
 
+           /*
+            * Return NULL if we reached NULL terminator, a lone backslash
+             * is not a valid character in PostScript.
+            */
+
+            if (!*cur)
+            {
+              *ptr = NULL;
+
+              return (NULL);
+            }
+
             if (*cur == 'b')
 	      *valptr++ = '\b';
 	    else if (*cur == 'f')
